# Routing tables for policy routing
/routing table
add fib name=to-WAN1
add fib name=to-WAN2

# Addresses
/ip address
add address=192.168.1.1/24 interface=ether3
add address=10.10.10.2/30   interface=ether2
add address=10.20.10.2/30   interface=ether1

# PCC: split NEW LAN connections 50/50 and keep them sticky
# IMPORTANT: mark-routing only on packets coming IN from LAN
/ip firewall mangle
add chain=prerouting in-interface=ether3 connection-state=new \
    per-connection-classifier=both-addresses-and-ports:2/0 \
    action=mark-connection new-connection-mark=WAN1_conn passthrough=yes
add chain=prerouting in-interface=ether3 connection-state=new \
    per-connection-classifier=both-addresses-and-ports:2/1 \
    action=mark-connection new-connection-mark=WAN2_conn passthrough=yes

add chain=prerouting in-interface=ether3 connection-mark=WAN1_conn \
    action=mark-routing new-routing-mark=to-WAN1 passthrough=no
add chain=prerouting in-interface=ether3 connection-mark=WAN2_conn \
    action=mark-routing new-routing-mark=to-WAN2 passthrough=no

# NAT: bypass lab LAN↔“internet” segment; masquerade per WAN mark
/ip firewall nat
add chain=srcnat src-address=192.168.1.0/24 dst-address=192.168.2.0/24 action=accept
add chain=srcnat src-address=192.168.2.0/24 dst-address=192.168.1.0/24 action=accept
add chain=srcnat routing-mark=to-WAN1 action=masquerade
add chain=srcnat routing-mark=to-WAN2 action=masquerade
# optional fallbacks for router-originated flows:
add chain=srcnat out-interface=ether1 action=masquerade
add chain=srcnat out-interface=ether2 action=masquerade

# One default per custom table (monitored)
/ip route
add dst-address=0.0.0.0/0 gateway=10.10.10.1 routing-table=to-WAN1 check-gateway=ping
add dst-address=0.0.0.0/0 gateway=10.20.10.1 routing-table=to-WAN2 check-gateway=ping

# Main table: simple failover (does not affect marked flows)
/ip route
add dst-address=0.0.0.0/0 gateway=10.10.10.1 distance=1 check-gateway=ping
add dst-address=0.0.0.0/0 gateway=10.20.10.1 distance=2 check-gateway=ping

# Policy rules
/routing rule
add routing-mark=to-WAN1 action=lookup table=to-WAN1
add routing-mark=to-WAN2 action=lookup table=to-WAN2